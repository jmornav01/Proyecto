![[Pasted image 20231124110907.png]]
### Contenidos
- [[#Icinga2]]
	- [[#Zonas]]
	- [[#Huéspedes]]
	- [[#Servicios]]
	- [[#Ajustes útiles]]
- [[#Agentes]]
- [[#Plugins]]
- [[#Notificaciones]]

### Icinga2

Es hora de desplegar el docker-compose.yml:
```
docker compose up -d 
```

Nos metemos en el contenedor
```
docker exec -u root -it icinga-playground_icinga2_1 /bin/bash
```

```
icinga2 node wizard
```
- *n*
- *master.javier.lan*
- por defecto (master)
- por defecto (N)
- por defecto (todas)
- por defecto (5665)
- por defecto (Y)

```
 icinga2 node wizard
Welcome to the Icinga 2 Setup Wizard!

We will guide you through all required configuration details.

Please specify if this is an agent/satellite setup ('n' installs a master setup) [Y/n]: n

Starting the Master setup routine...

Please specify the common name (CN) [master.javier.lan]:                  
Reconfiguring Icinga...
Checking for existing certificates for common name 'master.javier.lan'...
Certificate '/var/lib/icinga2/certs//master.javier.lan.crt' for CN 'master.javier.lan' already existing. Skipping certificate generation.
Generating master configuration for Icinga 2.
'api' feature already enabled.

Master zone name [master]: 

Default global zones: global-templates director-global
Do you want to specify additional global zones? [y/N]: 
Please specify the API bind host/port (optional):
Bind Host []: 
Bind Port []: 

Do you want to disable the inclusion of the conf.d directory [Y/n]: 
Disabling the inclusion of the conf.d directory...
Checking if the api-users.conf file exists...

Done.

Now restart your Icinga 2 daemon to finish the installation!
```

Tal y como nos indica en la documentación oficial, el wizard se encarga de:
>- Habilitar la API.
>- Generar la autoridad certificadora (CA) en `/var/lib/icinga2/ca` si aún no existe. 
>- Crear el certificado de este nodo, firmado con la clave de CA.
>- Actualizar el archivo `zones.conf` con la nueva jerarquía.
>- Actualizar el ApiListener y las constantes globales.
>- Actualizar el archivo `icinga2.conf` para deshabilitar la inclusión del directorio `conf.d`, y añadir la inclusión del archivo `api-users.conf`.

> [!info] [docker-compose-icinga](https://github.com/jjethwa/icinga2) ya nos despliega un entorno experimental, o de muesta, donde ya se han realizado algunos de estos pasos, como el de la CA y la API. Pero solo de cara a la red, al conjunto de contenedores desplegados. Por ello tenemos que utilizar el wizard.

#### Zonas
Los endpoints (maestros, satélites y agentes) deben pertenecer a una zona. Hay mil maneras de organizarlo. De momento tendremos:
1. La zona "master":
	-  endpoint "master.javier.lan",
- La zona "vm1":
	- endpoints "vm1.javier.lan".
	- Depende de la zona "master". 
- La zona "vm2":
	- endpoints "vm2.javier.lan".
	- Depende de la zona "master". 

```
/etc/icinga2/zones.conf
```
```java
/*
 * Generated by Icinga 2 node setup commands
 * on 2023-09-26 11:54:27 +0000
 */

///////////////////////////JAVIER.LAN////////////////////////////

object Endpoint "master.javier.lan" {}

object Zone "master" {
	endpoints = [ "master.javier.lan" ]
}

object Endpoint "vm1.javier.lan" {}

object Zone "vm1.javier.lan" {
	endpoints = [ "vm1.javier.lan" ]
	parent = "master"
}

object Endpoint "vm2.javier.lan" {}

object Zone "vm2.javier.lan" {
	endpoints = [ "vm2.javier.lan" ]
	parent = "master"
}

///////////////////////////JAVIER.LAN////////////////////////////

object Zone "global-templates" {
	global = true
}

object Zone "director-global" {
	global = true
}

```

Comprobamos no haya errores de sintaxis y  haya detectado los cambios:
> [!success] `icinga2 daemon -C`
> ...
> [2023-11-13 14:48:32 +0000] information/ConfigItem: Instantiated 5 Zones.
> [2023-11-13 14:48:32 +0000] information/ConfigItem: Instantiated 4 Endpoints.
> ...

Podemos comprobar las zonas:
```
icinga2 object list --type Zone | grep Object
```
```
Object 'vm3.javier.lan' of type 'Zone':
Object 'director-global' of type 'Zone':
Object 'vms' of type 'Zone':
Object 'master' of type 'Zone':
Object 'global-templates' of type 'Zone':
```

Nos vamos al directorio `/etc/icinga2/zones.d` y creamos la carpeta `master` donde almacenaremos todos los archivos de configuración de la zona. Es hora de definir los huéspedes.

#### Huéspedes
Hay varias maneras de definirlos. Podemos importar "plantillas" con ajustes predefinidos, tanto por nosotros como por Icinga2. "vm1" sin plantilla, con sus ajustes particulares, y "vm2" con la plantilla que también veremos. 

```
vim /etc/icinga2/zones.d/master/hosts.conf 
```
```java
object Host "ldap.javier.lan" {
  check_command = "hostalive"
  address = "10.0.2.253"
}

object Host "vm1.javier.lan" {
  check_command = "hostalive"
  address = "10.0.2.1"
  vars.agent_endpoint = name 
}

object Host "vm2.javier.lan" {
  import "generic-host"
  address = "10.0.2.4"
  vars.agent_endpoint = name 
}
```

La variable `vars.agent_endpoint` se refiere a la dirección del endpoint, que en este, y en la mayoría de los casos, por convención, es el mismo que el del Huésped ^1

La plantilla "generic-host" se encuentra por defecto en /etc/icinga2/conf.d/templates.conf. Con el wizard, desactivamos la inclusividad del directorio conf.d. Solo necesitamos copiarlo a la carpeta zones.d/master/, por lo menos la plantilla "generic-host": ^46926c
```
cp /etc/icinga2/conf.d/templates.conf /etc/icinga2/zones.d/master/
```
```
cat /etc/icinga2/zones.d/master/templates.conf
```
```
template Host "generic-host" {
  max_check_attempts = 3
  check_interval = 1m
  retry_interval = 30s

  check_command = "hostalive"
}
```

Icinga2 hará lo mismo en ambos huéspedes, ejecutará un ping (comando `hostalive`) a la dirección especificada en el objeto host. Ya sea importando la instrucción de la plantilla, o del propio objeto Host. Las plantillas son útiles para grupos de equipos similares. Iremos viendo plantillas de notificación, comándos y servicios.  

> [!success] `icinga2 daemon -C`
> ...
> [2023-11-13 19:42:32 +0000] information/ConfigItem: Instantiated 3 Hosts.
> ...

En este momento ya podemos verificarlos en la página web.
```
exit
docker restart icinga-playground_icinga2_1
```

Podremos acceder a icingaweb en localhost:8080 o si ya ha configurado el proxy, con *icinga.javierlan.duckdns.org* . El usuario por defecto es "icingaadmin" y su contraseña "icinga".

![[Pasted image 20231113205006.png]]

Si seleccionamos algún huésped y nos vamos a "fuente" podemos ver de donde saca Icingaweb la información del huesped, la sintaxis del comando ejecutado (`check_ping`), etc...

![[Pasted image 20231113205138.png]]

Para que nos aparezcan todos los detalles en el "tablero de control", deberemos añadir servicios que monitorear. Al fin y al cabo, un `ping` lo podemos hacer desde cualquier terminal. 

#### Servicios
En este caso, Icinga2 envía instrucciones a los endpoints donde se ubicará una instancia de Icinga2, actuando como agente en el huésped. De esta manera puede consultar información del hardware al equipo. 

>[!quote] [Icinga2 Community](https://community.icinga.com/t/not-able-to-execute-hostcheck-on-the-host-itself/6122)
>*That aside: Is the host you are talking about a windows server or a linux server?  
**If it is a linux server you could “upgrade” it to a satellite, which is able to run host checks against itself.  **
I have never tried this with a windows agent, so I’m not sure if that is even possible.*

Los servicios en Icinga2 se consultan mediante un `check_command`. Si el comando debe ser ejecutado en un equipo distinto, se lo indicamos con `command_endpoint`, que puede contener una variable como `agent_endpoint` que definimos anteriormente en  [[#^1|host.conf]]. Para indicar dónde se asigna la regla `apply` utilizamos `assign where`, que solo signará la regla al los huéspedes que tengan definida la variable `agent_endpoint`. 

```
vim /etc/icinga2/zones.d/master/services.conf 
```
```java
apply Service "disk" {
  check_command = "disk"
  command_endpoint = host.vars.agent_endpoint
  assign where host.vars.agent_endpoint 
}
```

Tenemos tantos servicios como comandos:
```java
apply Service "users" {
  check_command = "users"
  command_endpoint = host.vars.agent_endpoint
  assign where host.vars.agent_endpoint
}

apply Service "SSH Service" {
  check_command = "ssh"
  assign where host.address
}

apply Service "System Load" {
  check_command = "load"
  command_endpoint = host.vars.agent_endpoint 
  assign where host.vars.agent_endpoint 
}

apply Service "Icinga2 engine" {
  check_command = "icinga"
  command_endpoint = host.vars.agent_endpoint
  assign where host.vars.agent_endpoint
}
```

También quiero monitorizar la carga CPU del propio servidor LDAP sin tener que añadir otra regla, y el demonio slapd, y comprobar que sus datos estan disponibles.  Para la carga, podemos utilizar la regla `apply` anterior, haciendo los siguientes ajustes a la sección `assing where`. 
```java
apply Service "Local System Load" {
  check_command = "load"
  assign where (host.vars.agent_endpoint || host.name == "ldap.javier.lan")
}

apply Service "LDAP Service" {
  check_command = "ldap"
  vars.ldap_host = "ldap.javier.lan" 
  vars.ldap_base = "ou=miembros,dc=javier,dc=lan" 
  vars.ldap_v3 = true
  assign where host.name == "ldap.javier.lan" 
}
```


> [!success] `icinga2 daemon -C`
> ...
> [2023-11-14 16:34:21 +0000] information/ConfigItem: Instantiated 7 Services.
> ...

```
exit
docker restart icinga-playground_icinga2_1 
```

Recordemos que `vm2.javier.lan` importa la plantilla `generic-host`. Hasta ahora, esto no nos ha servido de mucho, pero mas adelante le aplicaremos servicios específicos.  

#### Ajustes útiles
Cuando no tengamos colectividad con algún agente, es innecesario mantener a Icinga2 realizando checks y enviándonos notificaciones de errores en otros servicios si, al fin y al cabo, no conocemos su estado. 

Para ello Icinga2 utiliza las Dependencias, que nos permiten crear árboles de servicios y huéspedes en los que podamos silenciar aquellos servicios dependientes en el caso de que su *padre* falle. 

En este caso me voy a referir a la situación anterior, donde el servicio padre será `Ping`y de él dependerán el resto de servicios. Icinga2 detendrá los checks y las notificaciones hasta que este retorne al estado *OK*
```bash
vim /etc/icinga2/zones.d/master/services.conf
```
```java
apply Service "Ping" {
  check_command = "ping4"
  assign where host.address
}

apply Dependency "dependencia-de-ping" to Service {
  parent_service_name = "Ping"
  disable_notifications = true
  disable_checks = true
  assign where host.vars.agent_endpoint // Asigna automáticamente todos los checks de endpoints del agente como servicios secundarios en el host coincidente.
  ignore where service.name == "Ping" // Evita la auto referencia de hijo al servicio padre
}
```


![[Pasted image 20231116170340.png]]

### Agentes

Instalamos Icinga2: 
```bash
apt update
apt -y install apt-transport-https wget gnupg

wget -O - https://packages.icinga.com/icinga.key | gpg --dearmor -o /usr/share/keyrings/icinga-archive-keyring.gpg

DIST=$(awk -F"[)(]+" '/VERSION=/ {print $2}' /etc/os-release); \
 echo "deb [signed-by=/usr/share/keyrings/icinga-archive-keyring.gpg] https://packages.icinga.com/debian icinga-${DIST} main" > \
 /etc/apt/sources.list.d/${DIST}-icinga.list
 echo "deb-src [signed-by=/usr/share/keyrings/icinga-archive-keyring.gpg] https://packages.icinga.com/debian icinga-${DIST} main" >> \
 /etc/apt/sources.list.d/${DIST}-icinga.list

apt update
```

```bash
apt install icinga2 -y
apt install monitoring-plugins -y
```


```
icinga2 node wizard
```
- por defecto (Y)
- vm1.javier.lan
- master.javier.lan
- master.javier.lan
- 5665
- por defecto (N)
- Y

```
icinga2 node wizard
Welcome to the Icinga 2 Setup Wizard!

We will guide you through all required configuration details.

Please specify if this is an agent/satellite setup ('n' installs a master setup) [Y/n]: 

Starting the Agent/Satellite setup routine...

Please specify the common name (CN) [vm1.javier.lan]: 

Please specify the parent endpoint(s) (master or satellite) where this node should connect to:
Master/Satellite Common Name (CN from your master/satellite node): master.javier.lan

Do you want to establish a connection to the parent node from this node? [Y/n]: 
Please specify the master/satellite connection information:
Master/Satellite endpoint host (IP address or FQDN): master.javier.lan
Master/Satellite endpoint port [5665]: 

Add more master/satellite endpoints? [y/N]: 
Parent certificate information:

 Version:             3
 Subject:             CN = master.javier.lan
 Issuer:              CN = Icinga CA
 Valid From:          Nov 20 21:44:04 2023 GMT
 Valid Until:         Dec 21 21:44:04 2024 GMT
 Serial:              74:86:43:f0:1f:5c:a6:6a:a2:eb:7d:04:79:59:a5:d6:d4:9b:bd:0b

 Signature Algorithm: sha256WithRSAEncryption
 Subject Alt Names:   master.javier.lan
 Fingerprint:         0C 6B CC 38 E2 A5 E4 AC 38 E8 E3 5D 9A 1A 0B 23 CC 7B 36 4E A0 83 BE FB 3A 59 8E 48 FB 66 99 72 

Is this information correct? [y/N]: y
Please specify the request ticket generated on your Icinga 2 master (optional).
 (Hint: # icinga2 pki ticket --cn 'vm1.javier.lan'): 
```
**De vuelta al master.javier.lan**
Generamos el ticket:
```
icinga2 pki ticket --cn vm1.javier.lan 
```
```
9e6e8f3037e4548a5dc536adeac322a33bee160a
```

Y ese código (que será distinto en su caso) lo pegamos en el agente.

- Por defecto (todas)
- Por defecto (5665)
- *Y
- *Y
- Por defecto (vm1.javier.lan)
- Por defecto (master)
- Por defecto (N)
- Por defecto (Y)

```
Please specify the API bind host/port (optional):
Bind Host []: 
Bind Port []: 

Accept config from parent node? [y/N]: y
Accept commands from parent node? [y/N]: y

Reconfiguring Icinga...

Local zone name [vm1.javier.lan]: 
Parent zone name [master]: 

Default global zones: global-templates director-global
Do you want to specify additional global zones? [y/N]: 

Do you want to disable the inclusion of the conf.d directory [Y/n]: 
Disabling the inclusion of the conf.d directory...

Done.

Now restart your Icinga 2 daemon to finish the installation!
```

Una vez terminado:
```
systemctl restart icinga2
```

Podemos comprobar la configuración recibida. 
```
cat /etc/icinga2/zones.conf
```
```java
//*
 * Generated by Icinga 2 node setup commands
 * on 2023-10-14 12:48:41 +0200
 */

object Endpoint "master.javier.lan" {
	host = "10.0.2.253"
	port = "5665"
}

object Zone "master" {
	endpoints = [ "master.javier.lan" ]
}

object Endpoint "vm1.javier.lan" {
}

object Zone "vm1.javier.lan" {
	endpoints = [ "vm1.javier.lan" ]
	parent = "master"
}

object Zone "global-templates" {
	global = true
}

object Zone "director-global" {
	global = true
}

```

Ahora podremos ver los servicios de vm1.javier.lan en icingaweb, en el Tablero de control.

![[Pasted image 20231114184322.png]]

### Plugins

Hay un servicio que no hemos monitorizado aún, y es la memoria. Icinga2 nos provee de 2 objetos `CheckCommand` definiendo los parámetros y la ruta del ejecutable. 

Tal vez sea una particularidad de docker-compose-icinga, pero los archivos **no están en ningún sitio**. Hay que descargarlos y moverlos al PlugingContribDir, definido en `/etc/icinga2.conf/constants.conf` y que por defecto suele ser `/usr/lib/nagios/plugins/`

Por desgracia los nuevos plugins instalados en el `master` no se actualizan en los agentes. 

**[Check_mem](https://github.com/justintime/nagios-plugins)**
CheckCommand =>`/usr/share/icinga2/include/plugins-contrib.d/operating-system.conf`
Command => `/usr/lib/nagios/plugins/check_mem.pl`

Este sin embargo no funciona bien. 
```
# /usr/lib/nagios/plugins/check_mem.pl -w 80 -c 95 -u
WARNING - 89.2% (901796 kB) used-percentage!|TOTAL=1011060KB;;;; USED=901796KB;808848;960507;; FREE=109264KB;;;; CACHES=610280KB;;;;

# free | grep Mem | awk '{print $3/$2 * 100.0}'
28.3789
```

**[Check-snmp-mem](http://nagios.manubulon.com/snmp_mem.html)**
CheckCommand => `/usr/share/icinga2/include/command-plugins-manubulon.conf`
Command => `/usr/lib/nagios/plugins/check_snmp_mem.pl`

Sus dependencias están obsoletas.


Lo único que funciona bien es:
**[Check_ram](https://github.com/ozzi-/check_ram)**
```
# /etc/icinga2/scripts/check_ram.sh
OK: 33% memory used |used=33%;80;90;0;100

# free | grep Mem | awk '{print $3/$2 * 100.0}'
33.5096
```

Vamos a instalarlo. 

```bash
apt install git -y
cd /etc/icinga2/scripts/
git clone https://github.com/ozzi-/check_ram.git
cp check_ram/check_ram.sh ./
chmod +x check_ram.sh 
```
```bash
vim /usr/share/icinga2/include/command-plugins.conf 
```
```java
object CheckCommand "check-ram" {
  command = [ ConfigDir + "/scripts/check_ram.sh" ]
  arguments += {
    "-c" = "$cfr_critical$"
    "-w" = "$cfr_warning$"
  }
}
```

```bash
vim /etc/icinga2/zones.d/master/services.conf 
```
```java
apply Service "ram" {
	check_command = "check-ram"
	command_endpoint = host.vars.agent_endpoint
  	assign where host.vars.agent_endpoint
}
```

Pero nuestros agentes aún no tienen este comando.
![[Pasted image 20231115164801.png]]

>[!quote] [Icinga2](https://icinga.com/docs/icinga-2/latest/doc/06-distributed-monitoring/#global-zone-for-config-sync)
>Plugin scripts and binaries must not be synced, this is for Icinga 2 configuration files only. **Use your preferred package repository and/or configuration management tool (Puppet, Ansible, Chef, etc.) for keeping packages and scripts uptodate.**


Hay muchas maneras de solucionar esto. La mas sencilla es simplemente sincronizar la carpeta `/etc/icinga2/scripts/` y las definiciones de comandos con las del agente. 

```bash
rsync -aP -og --chown=nagios:nagios -e 'ssh -p 23' /etc/icinga2/scripts/* root@vm1.javier.lan:/etc/icinga2/scripts/
```
```bash
rsync -aP -og --chown=nagios:nagios -e 'ssh -p 23' /usr/share/icinga2/include/command-plugins.conf root@vm1.javier.lan:/usr/share/icinga2/include/command-plugins.conf
```

Reiniciamos los agentes
```bash
systemctl restart icinga2
```

![[Pasted image 20231115171023.png]]
### Notificaciones
- [[Rocketchat]]
- [[Gmail]]
