Había pensado en añadir el almacenamiento del disco compartido `/dev/sdb1/` montado en `/miembros` al *Dashboard* de Icingaweb. Para eso no hace falta instalar Icinga2 en el servidor. Podemos enviar comandos mediante SSH desde el contenedor. 

```bash
docker exec -u root -it icinga2_icinga2_1 /bin/bash
```

En Icinga2 por docker, el usuario `icinga` no existe. Si que existe `nagios` que cumple exactamente la misma función. Ya que sus permisos se limitan a la ejecución de los comandos de icinga, habrá que crear la carpeta `.ssh` con `root` y concederle la propiedad de esta a `nagios`:
```bash
mkdir /var/lib/nagios/.ssh
chown nagios:nagios /var/lib/nagios/.ssh
```
El usuario `nagios` tampoco tiene una `shell` por lo que tendremos que autenticarnos de la siguiente manera:
```bash
su -l nagios -s /bin/bash
```
```bash
ssh-keygen -b 4096 -t rsa -C "icinga@$(hostname) user for check_by_ssh" -f $HOME/.ssh/id_rsa
```

En el agente (que utiliza el demonio Icinga2), le configuramos una contraseña temporal al usuario `icinga`.
```bash
useradd -m icinga
passwd icinga
```

De vuelta al contendor, copiamos nuestra y nos autenticamos con la contraseña que acabamos de otorgarle al usuario ``icinga``. 
```bash
ssh-copy-id -p 23 -i $HOME/.ssh/id_rsa icinga@ldap.javier.lan
```
```bash
ssh -p 23 -i $HOME/.ssh/id_rsa icinga@ldap.javier.lan
```

En el agente:
```
passwd -l icinga
```

Añadimos un servicio que será nuestra partición /miembros en el propio servidor:
```yaml
apply Service "nfs-disk" {
  import "generic-service"
  check_command = "by_ssh"
  vars.by_ssh_command = [ "/usr/lib/nagios/plugins/check_disk" ]
  vars.by_ssh_port = 23
  vars.by_ssh_logname = "icinga"
  vars.by_ssh_identity = [ "/var/lib/nagios/.ssh/id_rsa" ]
  vars.by_ssh_arguments = {
        "-w" = "20%"
        "-W" = "20%"
        "-c" = "10%"
        "-K" = "10%"
        "-p" = [ "/miembros" ]
    }
  assign where host.address == "10.0.2.253"
}
```

![[Pasted image 20231130182534.png]]

