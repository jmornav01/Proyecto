```
apt-get install git -y
```
```
git clone https://github.com/jjethwa/icinga2.git
```

```
cd icinga2
vim docker-compose.yml
```

Vamos a comentar la sección de Graphite, no es necesario, y MySQL ya que utilizaremos nuestro propio servidor MariaDB en la máquina virtual. 

```yaml
version: '2'
services:
  icinga2:
    #image: jordan/icinga2
    build:
      context: ./
      dockerfile: Dockerfile
    restart: on-failure:5
    # Set your hostname to the FQDN under which your
    # sattelites will reach this container
    hostname: master.javier.lan
    env_file:
      - secrets_sql.env
    environment:
      #      - ICINGA2_FEATURE_GRAPHITE=1
      # Important:
      # keep the hostname graphite the same as
      # the name of the graphite docker-container
      #      - ICINGA2_FEATURE_GRAPHITE_HOST=graphite
      #      - ICINGA2_FEATURE_GRAPHITE_PORT=2003
      #      - ICINGA2_FEATURE_GRAPHITE_URL=http://graphite
      # - ICINGA2_FEATURE_GRAPHITE_SEND_THRESHOLDS=true
      # - ICINGA2_FEATURE_GRAPHITE_SEND_METADATA=false
      #- ICINGAWEB2_ADMIN_USER=icingaadmin
      #- ICINGAWEB2_ADMIN_PASS=icinga
      #- ICINGA2_USER_FULLNAME=Icinga2 Docker Monitoring Instance
      - DEFAULT_MYSQL_HOST=10.0.2.253
    volumes:
      - ./data/icinga/cache:/var/cache/icinga2
      - ./data/icinga/certs:/etc/apache2/ssl
      - ./data/icinga/etc/icinga2:/etc/icinga2
      - ./data/icinga/etc/icingaweb2:/etc/icingaweb2
      - ./data/icinga/lib/icinga:/var/lib/icinga2
      - ./data/icinga/lib/php/sessions:/var/lib/php/sessions
      - ./data/icinga/log/apache2:/var/log/apache2
      - ./data/icinga/log/icinga2:/var/log/icinga2
      - ./data/icinga/log/icingaweb2:/var/log/icingaweb2
        #      - ./data/icinga/log/mysql:/var/log/mysql
      - ./data/icinga/spool:/var/spool/icinga2
      - ./data/icinga/cron.d/icinga:/etc/cron.d/icinga
      # Sending e-mail
      #  See: https://github.com/jjethwa/icinga2#sending-notification-mails
      #  If you want to enable outbound e-mail, edit the file mstmp/msmtprc
      #  and configure to your corresponding mail setup. The default is a
      #  Gmail example but msmtp can be used for any MTA configuration.
      #  Change the aliases in msmtp/aliases to your recipients.
      #  Then uncomment the rows below
      - ./msmtp/msmtprc:/etc/msmtprc:ro
      - ./msmtp/aliases:/etc/aliases:ro
    ports:
      - "80:80"
      - "443:443"
      - "5665:5665"
        #  graphite:
        #    image: graphiteapp/graphite-statsd:latest
        #    container_name: graphite
        #    restart: on-failure:5
        #    hostname: graphite
        #    volumes:
        #      - ./data/graphite/conf:/opt/graphite/conf
        #      - ./data/graphite/storage:/opt/graphite/storage
        #      - ./data/graphite/log/graphite:/var/log/graphite
        #      - ./data/graphite/log/carbon:/var/log/carbon
        #  mysql:
        #    image: mariadb
        #    container_name: mysql
        #    env_file:
        #      - secrets_sql.env
        #    volumes:
        #      - ./data/mysql/data:/var/lib/mysql
        #      # If you have previously used the container's internal DB use:
        #      #- ./data/icinga/lib/mysql:/var/lib/mysql
```

>[!info] Base de datos
>El archivo nos viene con un contenedor mysql listo para ser utilizado por Icinga2. Por razones de seguridad, conviene mantener la base de datos separada de la aplicación. Utilizaré un servidor MariaDB dentro de la propia máquina virtual. 

También he añadido las siguentes lineas al `Dockerfile` para que instale openssh-server y nano. Añádelas justo antes de la declaración `Entrypoint` para que no interfiera con el inicio. 

```Dockerfile
RUN  apt-get update && apt-get install -y openssh-server
RUN mkdir /var/run/sshd
RUN echo 'root:root' | chpasswd
# Prohibimos la autentiación por contraseña
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
EXPOSE 22
# Iniciamos el servidor
CMD ["/usr/sbin/sshd", "-D"]
RUN apt-get install nano -y

# Initialize and run Supervisor
ENTRYPOINT ["/opt/run"]
```

```bash
docker build -f Dockerfile .
```

