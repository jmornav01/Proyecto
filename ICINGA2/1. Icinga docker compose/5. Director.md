## Indice
- [[#Configuración básica]]
	- [[#Huéspedes]]
	- [[#Agente]]
	- [[#Servicios]]
- [[#Errores]]
## Configuración básica
### Huéspedes
Creamos una plantilla para los huéspedes. Yo lo he llamado "Agente Linux":
![[Pasted image 20231112164100.png]]

Con esta plantilla, ya podemos crear el huésped como tal:
Lo único que tendremos que indicar es el nombre y la dirección. Lo demás lo hereda de la plantilla que seleccionemos. 
![[Pasted image 20231112164335.png]]

Le damos a `Deploy`y lo tendremos listo:
![[Pasted image 20231112165655.png]]

Aún no hemos configurado ningún servicio para este host o su plantilla por lo que no lo encontraremos en el Tablero de control pero si en Panorama -> Huespedes:
![[Pasted image 20231112165945.png]]

### Agente

Hasta ahora, hemos configurado al huésped, pero no el agente, el `demonio` (que también podría ser un contenedor) Icinga2. Lo único que necesitamos es tener instalado Icinga2 en el huésped. 
Al ser un agente del director, no es necesario ejecutar el `wizard`. 

Nos dirigimos Icinga Director -> Hosts -> `vm3.javier.lan` (en mi caso) -> Pestaña superior derecha, "Agent".  Abajo se nos proporciona un script que tendremos que copiar y pegar en nuestro huésped:
![[Pasted image 20231212183429.png]]

En el huésped:
```
vim director-agent.sh
```

Pegamos el contenido del script, al que solo tendremos que indicarle el ticket que generaremos desde el CLI de icinga2. (`icinga2 pki ticket --cn vm3.javier.lan`). 
Las variables iniciales deberían quedarse así. 
```bash
#!/bin/bash

# This generates and signs your required certificates. Please do not
# forget to install the Icinga 2 package and your desired monitoring
# plugins first.

# Config from Director
ICINGA2_NODENAME='vm3.javier.lan'
ICINGA2_CA_TICKET='07252a57fb11fb75a9749deb9bdf81f72a3fce68'
ICINGA2_PARENT_ZONE='master'
ICINGA2_PARENT_ENDPOINTS=('master.javier.lan,')
ICINGA2_CA_NODE='master.javier.lan'
ICINGA2_GLOBAL_ZONES=('director-global')
...
...
```

Ejecutamos el script:
```
chmod u+x director-client.sh
./director-client.sh
```
```
INFO: This should be a Debian system
check: icinga2 installed - OK: 2.14.0-1
INFO: Using new SSL directory: /var/lib/icinga2/certs
information/base: Writing private key to '/var/lib/icinga2/certs/vm3.javier.lan.key'.
information/base: Writing X509 certificate to '/var/lib/icinga2/certs/vm3.javier.lan.crt'.
information/base: Writing certificate signing request to '/var/lib/icinga2/certs/vm3.javier.lan.csr'.
information/cli: Retrieving TLS certificate for 'master.javier.lan:5665'.

 Version:             3
 Subject:             CN = master.javier.lan
 Issuer:              CN = Icinga CA
 Valid From:          Nov 20 21:44:04 2023 GMT
 Valid Until:         Dec 21 21:44:04 2024 GMT
 Serial:              74:86:43:f0:1f:5c:a6:6a:a2:eb:7d:04:79:59:a5:d6:d4:9b:bd:0b

 Signature Algorithm: sha256WithRSAEncryption
 Subject Alt Names:   master.javier.lan
 Fingerprint:         0C 6B CC 38 E2 A5 E4 AC 38 E8 E3 5D 9A 1A 0B 23 CC 7B 36 4E A0 83 BE FB 3A 59 8E 48 FB 66 99 72 

***
*** You have to ensure that this certificate actually matches the parent
*** instance's certificate in order to avoid man-in-the-middle attacks.
***

information/pki: Writing certificate to file '/var/lib/icinga2/certs/trusted-master.crt'.
information/cli: Writing CA certificate to file '/var/lib/icinga2/certs/ca.crt'.
information/cli: Writing signed certificate to file '/var/lib/icinga2/certs/vm3.javier.lan.crt'.
INFO: Creating a backup at /etc/icinga2/icinga2.conf.orig
Writing config to /etc/icinga2/icinga2.conf
INFO: Creating a backup at /etc/icinga2/zones.conf.orig
Writing config to /etc/icinga2/zones.conf
INFO: Creating a backup at /etc/icinga2/features-available/api.conf.orig
Writing config to /etc/icinga2/features-available/api.conf
Enabling feature api. Make sure to restart Icinga 2 for these changes to take effect.
[2023-12-18 14:48:38 +0100] information/cli: Icinga application loader (version: r2.14.0-1)
[2023-12-18 14:48:38 +0100] information/cli: Loading configuration file(s).
[2023-12-18 14:48:38 +0100] information/ConfigItem: Committing config item(s).
[2023-12-18 14:48:38 +0100] information/ApiListener: My API identity: vm3.javier.lan
[2023-12-18 14:48:38 +0100] information/ConfigItem: Instantiated 1 IcingaApplication.
[2023-12-18 14:48:38 +0100] information/ConfigItem: Instantiated 1 FileLogger.
[2023-12-18 14:48:38 +0100] information/ConfigItem: Instantiated 3 Zones.
[2023-12-18 14:48:38 +0100] information/ConfigItem: Instantiated 1 CheckerComponent.
[2023-12-18 14:48:38 +0100] information/ConfigItem: Instantiated 2 Endpoints.
[2023-12-18 14:48:38 +0100] information/ConfigItem: Instantiated 1 NotificationComponent.
[2023-12-18 14:48:38 +0100] information/ConfigItem: Instantiated 1 ApiListener.
[2023-12-18 14:48:38 +0100] information/ConfigItem: Instantiated 246 CheckCommands.
[2023-12-18 14:48:38 +0100] information/ScriptGlobal: Dumping variables to file '/var/cache/icinga2/icinga2.vars'
[2023-12-18 14:48:38 +0100] information/cli: Finished validating the configuration file(s).
Please restart icinga2:
  systemctl restart icinga2
```

```
systemctl restart icinga2
```
### Servicios

Al igual que con los huéspedes, necesitamos crear una plantilla para los servicios. 
![[Pasted image 20231112171338.png]]

Y ahora creamos un servicio, en este caso para monitorizar el disco.
![[Pasted image 20231112172159.png]]

Una vez le damos a "deploy" nos aparecerá en el propio "Tablero de control":
![[Pasted image 20231112172531.png]]

![[Pasted image 20231112180524.png]]
