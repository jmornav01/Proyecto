
## Docker compose
Para mantenerlo mas organizado, he decidido mantener Cloudflare Tunnel y Traefik en el mismo compose.yml. 
En este archivo definimos lo siguiente:
- El conector cloudflare `tunnel_lan` con el token obtenido en la página y la nueva red `cftunnel-transport`.  
- El proxy `traefik` dentro de la red `ctunnel-transport` para recibir peticiones del conector cloudflare y la red `cloudflaretunnel`, a la que pertenecerán otros contenedores como Rocketchat y Portainer.   
	- Los únicos puertos que expondremos, 80 y 443. 
	- Los volúmenes para mantener la persistencia del archivo de configuración y los certificados de Let's Encrypt.
	- La configuración del dashboard de Traefik. Con ello podremos acceder a la interfaz web del proxy a través de *traefik.javierlan.net* una vez autenticados mediante el middleware `dashboard-auth` con una contraseña encriptada con la herramienta *htpasswd* del paquete *apache-utils* y copiamos el *output* del usuario y contraseña encriptada en el archivo compose.yml:
```bash
echo $(htpasswd -nb "admin" "contraseñaultracompleja") | sed -e s/\\$/\\$\\$/g
```


```bash
vim /srv/traefik-cloudflare/compose.yml
```
```yaml
version: "3.9"
services:
  tunnel_lan:
    container_name: cloudflared-tunnel
    image: cloudflare/cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=*********
    networks:
      - cftunnel-transport

  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: always
    networks:
      - cftunnel-transport
      - cloudflaretunnel
    ports:
      - 80:80
      - 443:443
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yaml:/traefik.yaml:ro
      - ./certificates.yaml:/certificates.yaml:ro
      - ./origin-certificates/:/origin-certificates:ro
      - ./traefik:/letsencrypt:rw
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.javierlan.net`)" 
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.services.traefik-dashboard.loadbalancer.server.port=8080"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=le" 
      - "traefik.http.routers.traefik-dashboard.middlewares=dashboard-auth"
      - "traefik.http.middlewares.dashboard-auth.basicAuth.users=admin:$$apr1$$GmO199Mg$$wvWVP2oKSZwPmmQ92gz/2/"

networks:
  cftunnel-transport:
  cloudflaretunnel:
    external: true
```

El archivo de configuración de Traefik. Aquí definiremos el Reto DNS entre Let's Encrypt y los servidores DNS de Cloudflare. 
- Todo el trafico http (web) será redirigido a https (websecure)
- El *certificateResolver* `le` obtiene certificados TLS desde el servidor `acme-staging-v02` 
- Los certificados generados se almacenarán donde indique `certificates.yaml`.

```
vim /srv/traefik-cloudflare/traefik.yaml
```
```yaml
api:
  insecure: false

entryPoints:
  web:
    address: ":80"
    http:
      redirections:
        entryPoint:
          to: "websecure"
          scheme: "https"
  websecure:
    address: ":443"

certificatesResolvers:
  le:
    acme:
      email: jmornav01@gmail.com
      storage: /letsencrypt/acme.json
      caServer: "https://acme-staging-v02.api.letsencrypt.org/directory"
      httpChallenge:
        entryPoint: websecure
      dnsChallenge:
        provider: cloudflare
        resolvers:
          - "1.1.1.1:53"
          - "8.8.8.8:53"

serversTransport:
  insecureSkipVerify: false

providers:
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false
  file:
    filename: certificates.yaml

log:
  level: "DEBUG" 
```

## Certificados

Nos dirigimos a Origin Server. Creamos dos certificados y los guardamos en la carpeta `/origin-certificates`.

![[Pasted image 20231219164642.png]]


En `certificates.yaml` indicaremos los certificados con los que encriptar el tráfico

```bash
vim /srv/traefik-cloudflare/certificates.yaml
```
```yaml
tls:
  stores:
    default:
      defaultCertificate:
        certFile: ./origin-certificates/javierlan.net.pem
        keyFile: ./origin-certificates/javierlan.net.key

  certificates:
    - certFile: ./origin-certificates/javierlan.net.pem
      keyFile: ./origin-certificates/javierlan.net.key

```

```
root@DESKTOP-EMOBBB1:/srv/traefik-clouflare
.
|-- certificates.yaml
|-- compose.yml
|-- letsencrypt
|   `-- acme.json
|-- logs
|-- origin-certificates
|   |-- javierlan.net.key
|   `-- javierlan.net.pem
|-- traefik
|   `-- acme.json
`-- traefik.yaml
```

