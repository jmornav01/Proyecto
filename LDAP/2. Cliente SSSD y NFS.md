La autenticación (o mejor dicho, petición de credenciales) por LDAP en Linux se puede realizar sin necesidad de instalar SSSD. La mayoría de las distribuciones cuentan con el módulo PAM y Nswitch que pueden recibir información de un servidor LDAP, teniendo eso si openldap instalado como cliente. 

SSSD nos permite tener varios dominios, y entre otras cosas, almacenar credenciales por el tiempo que queramos una vez autenticados con los mismos usuarios. Esto nos permite autenticarnos incluso cuando el servidor LDAP no se encuentre disponible. 
## SSSD
En un cliente cualquiera:
```bash
apt install sssd libpam-sss libnss-sss sssd-tools libsss-sudo
```

Creamos el archivo de configuración:
```bash
vim /etc/sssd/sssd.conf
```
```bash
[sssd]
services = nss, pam
config_file_version = 2
domains = default

[nss]
override_shell = /bin/bash

[pam]
offline_credentials_expiration = 60

[domain/default]
ldap_id_use_start_tls = True
cache_credentials = True
ldap_search_base = dc=javier,dc=lan
id_provider = ldap
auth_provider = ldap
chpass_provider = ldap
ldap_uri = ldap://ldap.javier.lan
ldap_default_bind_dn = cn=usuariolector,ou=miembros,dc=javier,dc=lan
ldap_default_authtok = usuariolector
ldap_tls_reqcert = never
ldap_tls_cacert = /etc/ssl/openldap/certs/mi_ca_certificado.pem
ldap_tls_cacertdir = /etc/ssl/openldap/certs
ldap_search_timeout = 50
ldap_network_timeout = 60
access_provider = simple

```
```bash
chmod 0600 /etc/sssd/sssd.conf
```

Creamos el directorio donde almacenaremos el certificado de nuestro servidor LDAP:
```
mkdir -p /etc/ssl/openldap/certs/
```
Desde el servidor, enviamos el certificado al cliente, en mi caso con la IP 10.0.2.7:
```bash
scp -P 23 /etc/ssl/certs/mi_ca_certificado.pem root@10.0.2.7:/etc/ssl/openldap/certs/
```

Volviendo al cliente:
```bash
vim /etc/ldap/ldap.conf
```
```
TLS_CACERT      /etc/ssl/openldap/certs/mi_ca_certificado.pem
```

Habilitamos la creación automática de directorios.
```bash
vim /etc/pam.d/common-session
```
```
session required        pam_mkhomedir.so skel=/etc/skel/ umask=0022
```

Añadimos `sss` a nsswitch:
```bash
vim /etc/nsswitch.conf
```
```bash
passwd:         files systemd  sss
group:          files systemd  sss
shadow:         files systemd  sss
```

Sin tocar nada mas,  deberíamos poder hacer:
```
[root@vm3:~]# su - user1
Creando directorio '/home/user1'.
[user1@vm3:~]$ pwd
/home/user1
[user1@vm3:~]$ exit
cerrar sesión
[root@vm3:~]# 
```

> [!info] Si no funciona, conviene mirar los logs del cliente en `/var/log/sssd/`, o los del servidor slapd con `journalctl -u slapd -e`. 

## NFS

Añadimos un disco para almacenar los directorios home de los usuarios miembros:
![[Pasted image 20231128170408.png]]

```
lsblk
```
```
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda      8:0    0   20G  0 disk
├─sda1   8:1    0   19G  0 part /
├─sda2   8:2    0    1K  0 part
└─sda5   8:5    0  975M  0 part [SWAP]
sdb      8:16   0   40G  0 disk
sr0     11:0    1 1024M  0 rom
```
En mi caso es el disco `sdb` de 40G.

Creamos una partición con todo el espacio, que por defecto será de tipo linux
```
fdisk /dev/sdb
```
```bash
Bienvenido a fdisk (util-linux 2.36.1).
Los cambios solo permanecerán en la memoria, hasta que decida escribirlos.
Tenga cuidado antes de utilizar la orden de escritura.

El dispositivo no contiene una tabla de particiones reconocida.
Se ha creado una nueva etiqueta de disco DOS con el identificador de disco 0xdb8ad7c5.

Orden (m para obtener ayuda): n
Tipo de partición
   p   primaria (0 primaria(s), 0 extendida(s), 4 libre(s))
   e   extendida (contenedor para particiones lógicas)
Seleccionar (valor predeterminado p): p
Número de partición (1-4, valor predeterminado 1):
Primer sector (2048-83886079, valor predeterminado 2048):
Último sector, +/-sectores o +/-tamaño{K,M,G,T,P} (2048-83886079, valor predeterminado 83886079):

Crea una nueva partición 1 de tipo 'Linux' y de tamaño 40 GiB.

Orden (m para obtener ayuda): w
Se ha modificado la tabla de particiones.
Llamando a ioctl() para volver a leer la tabla de particiones.
Se están sincronizando los discos.
```

Lo formateamos en `ext4`. 
```bash
mkfs.ext4 /dev/sdb1
```

```bash
apt install nfs-kernel-server -y
```

```bash
vim /etc/exports
```
```
/miembros	*(rw,sync,no_root_squash,no_subtree_check)
```
```bash
blkid /dev/sdb1
```
```
/dev/sdb1: UUID="29534e0b-811f-452c-a480-d9ffccaa56bf" BLOCK_SIZE="4096" TYPE="ext4" PARTUUID="094b1253-01"
```
```bash
vim /etc/fstab
```
```bash
UUID="29534e0b-811f-452c-a480-d9ffccaa56bf"	/miembros	ext4	defaults	0	0
```

Comprobamos que se monte correctamente:
```bash
mount -a
```
```
root@ldap:~# df -h
S.ficheros     Tamaño Usados  Disp Uso% Montado en
udev             962M      0  962M   0% /dev
tmpfs            198M   776K  197M   1% /run
/dev/sda1         19G    15G  3,0G  84% /
...
...
/dev/sdb1         40G    24K   38G   1% /miembros
```

```bash
systemctl restart nfs-kernel-server
```

En el cliente:
```bash
apt-get install nfs-common -y
```

```bash
vim /etc/fstab
```
```bash
10.0.2.253:/miembros	/miembros	nfs	auto,noatime,nolock,bg,intr,tcp	0	0
```

Montamos las particiones:
```
mount -a
```

## Prueba

Nos vamos a nuestra web LAM, cambiamos el directorio /home de algún usuario y guardamos los cambios:
![[Pasted image 20231220121017.png]]

En el cliente:

```
[root@vm1:~]# su user1
[user1@vm1:/root]$ cd
[user1@vm1:~]$ pwd
/miembros/user1
[user1@vm1:~]$ exit
exit
```


>[!warning] Directorios home
>Si se ha autenticado previame