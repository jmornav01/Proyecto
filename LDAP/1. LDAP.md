
- [[#Instalación y configuración]]
- [[#Datos]]
	- [[#Unidades organizativas y grupos]]
	- [[#Usuarios]]
	- [[#Invitados]]
- [[#Acciones importantes]]
- [[#Logging]]
- [[#TLS]]
	- [[#TLS en el cliente]]
- [[#LDAP Account Manager]]
- [[#Fuentes]]

## Instalación y configuración

```
apt install slapd ldap-utils
```

```
dpkg-reconfigure slapd
```

![[Pasted image 20231108174927.png]]
![[Pasted image 20231108174955.png]]

En este caso, no importaría darle "Si", al ser esta una demostración. Pero en caso de que tenga una base ya poblada, no conviene eliminarla. En cualquier caso, se le dará la opción de hacer una copia en el siguiente paso.

![[Pasted image 20231108175558.png]]

## Datos
#### Unidades organizativas y grupos

```
vim /ldap/unidades_organizativas_y_grupos.ldif
```
```
dn: ou=miembros,dc=javier,dc=lan
objectClass: organizationalUnit
ou: Miembros

dn: ou=grupos,dc=javier,dc=lan
objectClass: organizationalUnit
ou: Grupos

dn: cn=informatica,ou=Grupos,dc=javier,dc=lan
objectClass: posixGroup
cn: informatica
gidNumber: 5000

dn: cn=usuarios,ou=Grupos,dc=javier,dc=lan
objectClass: posixGroup
cn: usuario
gidNumber: 5001
```

Lo subimos a slapd.
```
ldapadd -x -D cn=admin,dc=javier,dc=lan -W -f /ldap/unidades_organizativas_y_grupos.ldif
```
#### Usuarios
```
vim /ldap/miembros.ldif
```
```
dn: uid=sysadmin,ou=Miembros,dc=javier,dc=lan
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uid: sysadmin
sn: surname
givenName: Sysadmin
cn: Sysadmin
displayName: Sysadmin
uidNumber: 10000
gidNumber: 10000
userPassword: {CRYPT}sysadmin
gecos: Sysadmin
loginShell: /bin/bash
homeDirectory: /home/sysadmin

dn: uid=director,ou=Miembros,dc=javier,dc=lan
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uid: director
sn: dirsurname
givenName: Director
cn: Director
displayName: Director
uidNumber: 10001
gidNumber: 10001
userPassword: {CRYPT}director
gecos: director
loginShell: /bin/bash
homeDirectory: /home/director

dn: uid=user1,ou=Miembros,dc=javier,dc=lan
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uid: user1
sn: surname1
givenName: User1
cn: User1 Surname1
displayName: User1 Surname1
uidNumber: 10002
gidNumber: 10002
userPassword: {CRYPT}password1
gecos: User1 Surname1
loginShell: /bin/bash
homeDirectory: /home/user1

dn: uid=user2,ou=Miembros,dc=javier,dc=lan
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uid: user2
sn: surname2
givenName: User2
cn: User2 Surname2
displayName: User2 Surname2
uidNumber: 10003
gidNumber: 10003 
userPassword: {CRYPT}password2
gecos: User2 Surname2
loginShell: /bin/bash
homeDirectory: /home/user2

dn: uid=user3,ou=Miembros,dc=javier,dc=lan
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uid: user3
sn: surname3
givenName: User3
cn: User3 Surname3
displayName: User3 Surname3
uidNumber: 10004
gidNumber: 10004 
userPassword: {CRYPT}password3
gecos: User3 Surname3
loginShell: /bin/bash
homeDirectory: /home/user3

```

Lo subimos a slapd.
```
ldapadd -x -D cn=admin,dc=javier,dc=lan -W -f /ldap/miembros.ldif
```
#### Invitados
```
vim /ldap/invitados.ldif
```
```
dn: ou=Invitados,dc=javier,dc=lan
objectClass: organizationalUnit
ou: Invitados

dn: cn=guests,ou=Grupos,dc=javier,dc=lan
objectClass: posixGroup
cn: guests
gidNumber: 5002

dn: uid=invitado1,ou=Invitados,dc=javier,dc=lan
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uid: invitado1
sn: invitado1
givenName: Invitado1
cn: Invitado1 User
displayName: Invitado1 User
uidNumber: 15001
gidNumber: 15001
userPassword: {CRYPT}invitado1
gecos: Invitado1 User
loginShell: /bin/bash
homeDirectory: /home/invitado1

dn: uid=invitado2,ou=Invitados,dc=javier,dc=lan
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uid: invitado2
sn: invitado2
givenName: Invitado2
cn: Invitado2 User
displayName: Invitado2 User
uidNumber: 15002
gidNumber: 15002 
userPassword: {CRYPT}invitado2
gecos: Invitado2 User
loginShell: /bin/bash
homeDirectory: /home/invitado2
```

Lo subimos a slapd.
```
ldapadd -x -D cn=admin,dc=javier,dc=lan -W -f /ldap/invitados.ldif 
```

## Acciones importantes

Comprobamos los objetos cargados en la base
```
ldapsearch -xWD "cn=admin,dc=javier,dc=lan" -b "dc=javier,dc=lan" uid
```

LDAP por defecto no almacena la contraseña encriptada hasta que nosotros no se la "cambiamos" (*en este caso será la misma indicada en el archivo LDIF*). En ese momento la encriptara (`{CRYPT}`). 

- Ejemplo: Cambiar la contraseña de `user1`:
````
ldappasswd -H ldap://ldap.javier.lan -D "cn=admin,dc=javier,dc=lan" -x -W -S "uid=user1,ou=miembros,dc=javier,dc=lan"
````

Añadir usuarios al grupo `informatica`. 
```
vim /ldap/añadir_usuario_a_grupo.ldif
```
```
dn: cn=informatica,ou=Grupos,dc=javier,dc=lan
changetype: modify
add: memberuid
memberuid: director

dn: cn=informatica,ou=Grupos,dc=javier,dc=lan
changetype: modify
add: memberuid
memberuid: sysadmin
```

```
ldapmodify -x -W -D "cn=admin,dc=javier,dc=lan" -f /ldap/añadir_usuario_a_grupo.ldif
```

Comprobamos que se han unido correctamente
```
ldapsearch -x -LLL -b "cn=informatica,ou=grupos,dc=javier,dc=lan" "memberUid=*"
```

También conviene tener un usuario a parte del administrador que pueda algunos contenidos de nuestra base. Esto será importante cuando configuremos la autenticación por LDAP en otros servicios, ya que se enlazarán nuestro servicio utilizando un usuario específico. Es importante que ese usuario solo tenga permisos de lectura. 

Creamos el usuario
```
vim /ldap/usuariolector.ldif
```
```
dn: cn=usuariolector,ou=miembros,dc=javier,dc=lan
cn: readonly
objectClass: simpleSecurityObject
objectClass: organizationalRole
userPassword: {CRYPT}usuariolector
```

```
ldapadd -x -D "cn=admin,dc=javier,dc=lan" -W -f /ldap/usuariolector.ldif 
```

Le aplicamos la contraseña
```
ldappasswd -x -D "cn=admin,dc=javier,dc=lan" -W -S "cn=usuariolector,ou=miembros,dc=javier,dc=lan"
```

Creamos una Lista de Control de Accesos (ACL)
```
dn: olcDatabase={1}mdb,cn=config
changetype: modify
replace: olcAccess
olcAccess: {0}to attrs=userPassword,shadowLastChange
  by dn="cn=admin,dc=javier,dc=lan" write
  by dn="cn=usuariolector,ou=miembros,dc=javier,dc=lan" read
  by self write
  by anonymous auth
  by * none
olcAccess: {1}to dn.base="" by * read
olcAccess: {2}to *
  by dn="cn=admin,dc=javier,dc=lan" write
  by dn="cn=usuariolector,ou=miembros,dc=javier,dc=lan" read
  by self write
  by anonymous auth
  by * none
```

```
ldapmodify -x -D "cn=admin,dc=javier,dc=lan" -W -f permisos.ldif
```

> [!failure] ```
> modifying entry "olcDatabase={1}mdb,cn=config"
> dap_modify: Insufficient access (50)
> ```

> [!quote] [Superuser](https://superuser.com/questions/1681716/ldapmodify-insufficient-access-50)
> However, the _access list_ (olcAccess) for the cn=config database grants full unrestricted access to the DN `gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth`, which is the special DN that is used for clients that 1) connect through Unix socket and 2) use SASL EXTERNAL authentication.

```
ldapmodify -H ldapi:/// -Y EXTERNAL -f permisos.ldif
```
```
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
modifying entry "olcDatabase={1}mdb,cn=config"
```

Ahora solo el admin y el usuariolector pueden consultar la información del servidor:
```
ldapsearch -D "cn=usuariolector,ou=miembros,dc=javier,dc=lan" -W -ZZ -b dc=javier,dc=lan
```


## Logging

```
vim /etc/default/slapd
```
Añadimos a la última línea:
```
SLAPD_OPTIONS="-s 256"
```

A mi no me ha funcionado bien, por lo que lo miro en /var/log/syslog o `journalctl -u slapd -e`.

## TLS

```
apt install gnutls-bin ssl-cert
```

```
certtool --generate-privkey --bits 4096 --outfile /etc/ssl/private/mi_ca_clave.pem
```

vim /etc/ssl/ca.info
```
cn = JAVIER LAN
ca
cert_signing_key
expiration_days = 3650
```

```
certtool --generate-self-signed \
--load-privkey /etc/ssl/private/mi_ca_clave.pem \
--template /etc/ssl/ca.info \
--outfile /usr/local/share/ca-certificates/mi_ca_certificado.crt
```

```
certtool --generate-privkey \
--bits 2048 \
--outfile /etc/ldap/ldap_slapd_clave.pem
```


vim /etc/ssl/ldap.info
```
organization = JAVIER LAN
cn = ldap.javier.lan
tls_www_server
encryption_key
signing_key
expiration_days = 365
```

```
certtool --generate-certificate \
--load-privkey /etc/ldap/ldap_slapd_clave.pem \
--load-ca-certificate /etc/ssl/certs/mi_ca_certificado.pem \
--load-ca-privkey /etc/ssl/private/mi_ca_clave.pem \
--template /etc/ssl/ldap.info \
--outfile /etc/ldap/ldap_slapd_certificado.pem
```

```
chgrp openldap /etc/ldap/ldap_slapd_clave.pem
chmod 0640 /etc/ldap/ldap_slapd_clave.pem
```

vim /ldap/informacion_certificado.ldif
```
dn: cn=config
add: olcTLSCACertificateFile
olcTLSCACertificateFile: /etc/ssl/certs/mi_ca_certificado.pem
-
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ldap/ldap_slapd_certificado.pem
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ldap/ldap_slapd_clave.pem
```

Si ya teníamos un certificado anticuado, lo reemplazamos

```
dn: cn=config 
replace: olcTLSCACertificateFile 
olcTLSCACertificateFile: /etc/ssl/certs/mi_ca_certificado.pem 
-
dn: cn=config 
replace: olcTLSCertificateFile 
olcTLSCertificateFile: /etc/ldap/ldap_slapd_certificado.pem 
-
dn: cn=config 
replace: olcTLSCertificateKeyFile 
olcTLSCertificateKeyFile: /etc/ldap/ldap_slapd_clave.pem
```

**mi_ca_certificado.pem** es el certificado que debe estar en los clientes. 

```
vim /etc/ldap/ldap.conf
```
```
BASE dc=javier,dc=lan
URI ldap://ldap.javier.lan
TLS_CACERT /etc/ldap/ldap_slapd_certificado.pem
```

Configuramos LDAP para que escuche por el puerto 636 o LDAPS:
```
vim /etc/default/slapd
```
```
SLAPD_SERVICES="ldap:/// ldapi:/// ldaps:///"
```
```
systemctl restart slapd
```
Comprobamos que funcione
```
ldapmodify -Y EXTERNAL -H ldapi:/// -f /ldap/informacion_certificado.ldif
```

```
systemctl restart slapd
```

```
ldapwhoami -x -ZZ -H ldap://ldap.javier.lan
```
	anonymous

```
ldapwhoami -x -H ldap://ldap.javier.lan
```
	anonymous

#### TLS en el cliente
```
scp /etc/ssl/certs/mi_ca_certificado.pem 10.0.2.4:/etc/ssl/certs/
```
Debe tener instalado slapd. 

vim /etc/ldap/ldap.conf
```
TLS_CACERT	/etc/ssl/certs/mi_ca_certificado.pem
```

```
systemctl restart slapd
```

Probamos
```
ldapsearch -x -ZZ -h ldap.javier.lan -b dc=javier,dc=lan
```

Si has configurado una ACL añade `-D "cn=usuariolector,ou=miembros,dc=javier,dc=lan" -W` si te da `result: 50 Insufficient access`. Importante incluir `-W` para que se autentique con contraseña. 
## LDAP Account Manager

Una GUI a través del navegador para nuestro servidor LDAP. Se hospedará en un servidor apache2. Esta escrita en PHP por lo que necesitaremos descargar y activar algunos módulos php. 
```
apt install apache2 php php-cgi libapache2-mod-php php-mbstring php-common php-pear -y
```
```
a2enconf php7.4-cgi
```
```
systemctl reload apache2
```

Instalamos el paquete LDAP Account  Manager
```
apt install ldap-account-manager -y
```

Vamos a limitar el acceso a nuestro equipo y red local. Comentamos `Require all granted` y añadimos:
```
vim /etc/apache2/conf-enabled/ldap-account-manager.conf
```
```
# Require all granted
Require ip 127.0.0.1 192.168.1.0/24
```
```
systemctl restart apache2
```

El [docker-compose]((https://github.com/jjethwa/icinga2) que utilizaremos incluye un servidor apache para icingaweb que escucha por el puerto 80. Podemos cambiarlo en el archivo `docker-compose.yml`, o también podemos cambiar el puerto de nuestro apache2.  
```
vim /etc/apache2/ports.conf
```
```
# If you just change the port or add more ports here, you will likely also
# have to change the VirtualHost statement in
# /etc/apache2/sites-enabled/000-default.conf

Listen 81
```

Accedemos a la página `http://192.168.1.166:81/lam/`

Antes de nada, nos vamos a `LAM configuration` ==> `Edit server profiles`
La contraseña es "lam"
Una vez aquí:
Pestaña "General Settings"
- Server address: ldap://localhost:389
- List of valid users: `cn=admin,dc=javier,dc=lan`
- Profile password: En mi caso es "123"
Pestaña "Account types"
Users:
- LDAP suffix: `ou=miembros,dc=javier,dc=lan`
Groups:
- LDAP suffix: `ou=grupos,dc=javier,dc=lan`

Y abajo del todo, le damos a "save". 

Ya podremos autenticarnos con el usuario admin de nuestro propio servidor ldap. 

![[Pasted image 20231121121158.png]]

Desde aquí podremos realizar todas las gestiones de slapd. 

Si nos vamos a `Tools`==> `LDAP import/export` podremos subir nuestro código LDIF sin problema. Es mejor que estar escribiendo comandos con ldapscripts. 

## Fuentes

- https://ubuntu.com/server/docs/service-ldap
- https://www.thegeekstuff.com/2015/02/openldap-add-users-groups/
- https://docs.oracle.com/cd/E23824_01/html/821-1455/gladg.html
- https://openldap-software.0penldap.narkive.com/uYsWylPg/error-modifying-uid-or-dn-with-ldapmodify-naming-violation-64-value-of-naming-attribute-uid-is-not