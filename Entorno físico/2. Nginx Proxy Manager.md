Aunque se trate de una red interna, es importante asegurarla con certificados SSL, aunque estén firmados por nosotros mismos, pero podemos conseguir certificados de [Let's encrypt](https://letsencrypt.org/es/) utilizando [Duckdns](https://www.duckdns.org/) para los dominios internos. 

Con Nginx Proxy Manager, podemos certificar un domino por medio de un [Reto DNS](https://letsencrypt.org/es/docs/challenge-types/#dns-01-challenge), que será utilizado en todos los servicios de nuestra red interna, que en el caso de esta guía no serán mas que `icinga.javierlan.duckdns.org` y `lam.javierlan.duckdns.org. 

Para simplificar el despliegue, Nginx Proxy Manager lo desplegaré en el mismo docker-compose.yml de Icinga2.   
- Añadimos dos volúmenes para almacenar la configuración y los certificados y mantener así su persistencia después de los reinicios.
- Importante añadir una nueva red, `nginx_default` por ejemplo, para que Icinga y Nginx estén conectados.  
```yaml
version: '3.9'
services:
  nginxproxymanager:
    image: 'jc21/nginx-proxy-manager:latest'
    restart: unless-stopped
    ports:
      - '80:80'
      - '81:81'
      - '443:443'
    volumes:
      - ./nginx/data:/data
      - ./nginx/letsencrypt:/etc/letsencrypt
    networks:
      - nginx_default

  icinga2:
  ...
  ...
  ```

Al utilizar el proxy, no vamos a exponer el puerto 80 o 443 directamente desde Icinga, así que lo comentamos y especificamos la red `nginx_default`. 
```yaml
	  ports:
      #      - "80:80"
      #      - "443:443"
      - "5665:5665"
    networks:
      - nginx_default

networks:
  nginx_default:
```

Y dentro del mismo directorio:
```
mkdir -p nginx/data
mdkir nginx/letsencrypt
```

>[!warning] Recuerda que apache, cuando configuramos [[1. LDAP#LDAP Account Manager| LAM]], le configuramos el puerto 81. Cámbielo a 82 para que no haya conflicto.
>
>```
>vim /etc/apache2/ports.conf
>	Listen 82
>```
>```
systemctl restart apache2
>ufw allow 82
>```

Desplegamos los contenedores:
```
docker compose up -d
```
```
CONTAINER ID   IMAGE                             COMMAND                  CREATED          STATUS          PORTS                                             NAMES
c4a5b0173b7d   javier-icinga2                    "/opt/run /usr/sbin/…"   57 minutes ago   Up 11 seconds   22/tcp, 80/tcp, 443/tcp, 0.0.0.0:5665->5665/tcp   icinga2-icinga2-1
98c5bc1f2c27   jc21/nginx-proxy-manager:latest   "/init"                  57 minutes ago   Up 55 minutes   0.0.0.0:80-81->80-81/tcp, 0.0.0.0:443->443/tcp    icinga2-nginxproxymanager-1
```
- En el navegador -> *192.168.1.166:80*
![[Pasted image 20231218191432.png]]

- *192.168.1.166:81/login*
![[Pasted image 20231218191623.png]]
- Email address: *admin@example.com*
- Password: *changeme*

Nos pedirá que cambiemos nuestro correo y contraseña. Podemos especificar cualquier dirección de email. Nos conviene utilizar una contraseña fuerte, a poder ser con un gestor de contraseñas. 

- Con el Proxy funcionando, podemos crearnos una cuenta en [Duckdns](https://www.duckdns.org/) y crear un dominio:
![[Pasted image 20231218192312.png]]

Creamos un domino con el nombre que queramos y le indicamos la IP de nuestro proxy. La misma que la de nuestra interfaz puente. 
![[Pasted image 20231218192735.png]]
- Copiamos el token y volvemos a nginx. 

- Nos vamos a *SSL Certificates* y añadimos uno. 
![[Pasted image 20231218193041.png]]
- En Duckdns proporcionamos un nombre para el dominio, al que tendremos que añadir *duckdns.org*. Por lo que todos los servicios tendrán la url: *servicio.javierlan.duckdns.org*. 
- Con el token en el portapapeles, habilitamos la opción *Use a DNS Challenge* y lo pegamos en *Credentials File Content* dentro de la variable `dns_duckdns_token`.
![[Pasted image 20231218192957.png]]

- Aceptamos los términos y condiciones de Let's Encrypt y le damos a *save*. Tardará unos segundos en completarse.
- Ahora podemos añadir los huéspedes y sus nuevas direcciones. Empezando por el propio proxy:
![[Pasted image 20231218201307.png]]

- Le indicamos el certificado:
![[Pasted image 20231218201328.png]]

- Mismo proceso para el resto de sercios, con alguna diferencia:
  ![[Pasted image 20231218201651.png]]

- El proxy solo conoce la IP del puerto 82 expuesto por la interfaz puente de la máquina virtual, por lo que el host lam.javierlan.duckdns.org tiene la IP 192.168.1.166. 
- El proxy también puede ver los nombres e IP de los contenedores de la red `nginx_default`, el nombre del contenedor icinga, tal y como hemos definido en el `docker-compose.yml`, es icinga2. También podríamos indicar su IP interna, que ante la duda podríamos consultar con:
```
docker inspect --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' [ID del contenedor]
```

![[Pasted image 20231218202500.png]]

![[Pasted image 20231218202534.png]]

- Para LAM, accedemos como antes: *lam.javierlan.duckdns.org* ***/lam*** 
![[Pasted image 20231218202626.png]]